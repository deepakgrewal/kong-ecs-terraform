_format_version: '3.0'
_info:
  select_tags:
    - ecs-bedrock-auth
_konnect:
  control_plane_name: Demo

services:
  - name: ai-bedrock-auth
    host: localhost
    port: 80
    protocol: http
    tags:
      - ecs-bedrock-auth

    routes:
      - name: ai-bedrock-auth-route
        paths:
          - /ai/bedrock
        methods:
          - POST
        strip_path: true
        tags:
          - ecs-bedrock-auth

    plugins:
      - name: ai-proxy-advanced
        tags:
          - ecs-bedrock-auth
        config:
          targets:
            # APPROACH A: ECS task role (implicit IAM) — ACTIVE
            # No credentials in config. Kong uses the AWS credential chain:
            #   1. Plugin config (aws_access_key_id) — not set
            #   2. Environment variables (AWS_ACCESS_KEY_ID)
            #   3. ECS task role / container credentials
            #   4. EC2 instance profile
            #
            # Requires:
            #   - Kong Gateway >= 3.13.0.0
            #   - bedrock_model_arns set in terraform variables
            - route_type: llm/v1/chat
              auth:
                allow_override: false
              logging:
                log_statistics: true
                log_payloads: false
              model:
                name: anthropic.claude-3-haiku-20240307-v1:0
                provider: bedrock
                options:
                  bedrock:
                    aws_region: us-east-1
                  max_tokens: 4096
                  temperature: 0.7

            # APPROACH B: Assume role (cross-account) — COMMENTED
            # Uncomment when Bedrock models are in a different AWS account.
            #
            # - route_type: llm/v1/chat
            #   auth:
            #     allow_override: false
            #   logging:
            #     log_statistics: true
            #     log_payloads: false
            #   model:
            #     name: anthropic.claude-3-haiku-20240307-v1:0
            #     provider: bedrock
            #     options:
            #       bedrock:
            #         aws_region: us-east-1
            #         aws_assume_role_arn: "arn:aws:iam::TARGET_ACCOUNT_ID:role/ROLE_NAME"
            #         aws_role_session_name: "kong-ai-gateway"
            #       max_tokens: 4096
            #       temperature: 0.7
