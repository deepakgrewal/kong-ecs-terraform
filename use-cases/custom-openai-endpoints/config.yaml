_format_version: '3.0'
_info:
  select_tags:
    - custom-openai-endpoints
_konnect:
  control_plane_name: Demo

services:
  - name: ai-custom-openai
    host: localhost
    port: 80
    protocol: http
    tags:
      - custom-openai-endpoints

    routes:
      - name: ai-custom-openai-route
        paths:
          - /ai/custom
        methods:
          - POST
        strip_path: true
        tags:
          - custom-openai-endpoints

    plugins:
      - name: ai-proxy-advanced
        tags:
          - custom-openai-endpoints
        config:
          balancer:
            algorithm: round-robin
            retries: 3
            max_fails: 2
            fail_timeout: 30000
            failover_criteria:
              - error
              - timeout
              - http_429
              - http_500
              - http_502
              - http_503
              - non_idempotent

          targets:
            # PRIMARY: Custom OpenAI-compatible endpoint
            # Replace REPLACE_WITH_* values with your endpoint details
            - weight: 1000
              route_type: llm/v1/chat
              auth:
                header_name: Authorization
                header_value: "Bearer REPLACE_WITH_API_KEY"
                allow_override: false
              logging:
                log_statistics: true
                log_payloads: false
              model:
                name: REPLACE_WITH_MODEL_NAME
                provider: openai
                options:
                  upstream_url: "REPLACE_WITH_ENDPOINT"
                  max_tokens: 4096
                  temperature: 0.7

            # FALLBACK: Standard Bedrock model
            - weight: 1
              route_type: llm/v1/chat
              auth:
                allow_override: false
                aws_access_key_id: ${{ env "DECK_AWS_ACCESS_KEY_ID" }}
                aws_secret_access_key: ${{ env "DECK_AWS_SECRET_ACCESS_KEY" }}
              logging:
                log_statistics: true
                log_payloads: false
              model:
                name: anthropic.claude-3-haiku-20240307-v1:0
                provider: bedrock
                options:
                  bedrock:
                    aws_region: us-west-2
                  max_tokens: 4096
                  temperature: 0.7
